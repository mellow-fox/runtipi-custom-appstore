{
  "services": [
    {
      "name": "dawarich_redis",
      "image": "redis:7.4-alpine",
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/redis", "containerPath": "/data" }
      ],
      "healthCheck": {
        "test": "redis-cli --raw incr ping",
        "interval": "10s",
        "retries": 5,
        "timeout": "10s"
      }
    },
    {
      "name": "dawarich_db",
      "image": "postgis/postgis:17-3.5-alpine",
      "environment": {
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
        "POSTGRES_DB": "dawarich_development"
      },
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/db", "containerPath": "/var/lib/postgresql/data" },
        { "hostPath": "${APP_DATA_DIR}/shared", "containerPath": "/var/shared" }
      ],
      "healthCheck": {
        "test": "pg_isready -U postgres -d dawarich_development",
        "interval": "10s",
        "retries": 5,
        "timeout": "10s"
      }
    },
    {
      "name": "dawarich_app",
      "image": "freikin/dawarich:0.30.9",
      "isMain": true,
      "internalPort": 3000,
      "entrypoint": "web-entrypoint.sh",
      "command": ["bin/rails", "server", "-p", "3000", "-b", "::"],
      "environment": {
        "RAILS_ENV": "development",
        "REDIS_URL": "redis://dawarich_redis:6379",
        "DATABASE_HOST": "dawarich_db",
        "DATABASE_USERNAME": "postgres",
        "DATABASE_PASSWORD": "${POSTGRES_PASSWORD}",
        "DATABASE_NAME": "dawarich_development",
        "MIN_MINUTES_SPENT_IN_CITY": "60",
        "PHOTON_API_HOST": "${PHOTON_API_HOST}",
        "PHOTON_API_USE_HTTPS": "${PHOTON_API_USE_HTTPS}",
        "APPLICATION_HOSTS": "${APPLICATION_HOSTS}",
        "TIME_ZONE": "${TIME_ZONE}",
        "APPLICATION_PROTOCOL": "${APPLICATION_PROTOCOL}",
        "PROMETHEUS_EXPORTER_ENABLED": "false",
        "PROMETHEUS_EXPORTER_HOST": "0.0.0.0",
        "PROMETHEUS_EXPORTER_PORT": "9394",
        "SELF_HOSTED": "true",
        "STORE_GEODATA": "true"
      },
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/public", "containerPath": "/var/app/public" },
        { "hostPath": "${APP_DATA_DIR}/watched", "containerPath": "/var/app/tmp/imports/watched" },
        { "hostPath": "${APP_DATA_DIR}/storage", "containerPath": "/var/app/storage" },
        { "hostPath": "${APP_DATA_DIR}/db_backup", "containerPath": "/dawarich_db_data" }
      ],
      "healthCheck": {
        "test": "wget -qO - http://127.0.0.1:3000/api/v1/health | grep -q '\"status\"\\s*:\\s*\"ok\"'",
        "interval": "10s",
        "retries": 30,
        "timeout": "10s"
      },
      "dependsOn": {
        "dawarich_db": { "condition": "service_healthy" },
        "dawarich_redis": { "condition": "service_healthy" }
      }
    },
    {
      "name": "dawarich_sidekiq",
      "image": "freikin/dawarich:0.30.8",
      "entrypoint": "sidekiq-entrypoint.sh",
      "command": ["sidekiq"],
      "environment": {
        "RAILS_ENV": "development",
        "REDIS_URL": "redis://dawarich_redis:6379",
        "DATABASE_HOST": "dawarich_db",
        "DATABASE_USERNAME": "postgres",
        "DATABASE_PASSWORD": "${POSTGRES_PASSWORD}",
        "DATABASE_NAME": "dawarich_development",
        "PHOTON_API_HOST": "${PHOTON_API_HOST}",
        "PHOTON_API_USE_HTTPS": "${PHOTON_API_USE_HTTPS}",
        "APPLICATION_HOSTS": "${APPLICATION_HOSTS}",
        "BACKGROUND_PROCESSING_CONCURRENCY": "10",
        "APPLICATION_PROTOCOL": "${APPLICATION_PROTOCOL}",
        "PROMETHEUS_EXPORTER_ENABLED": "false",
        "PROMETHEUS_EXPORTER_HOST": "dawarich_app",
        "PROMETHEUS_EXPORTER_PORT": "9394",
        "SELF_HOSTED": "true",
        "STORE_GEODATA": "true",
        "TIME_ZONE": "${TIME_ZONE}"
      },
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/public", "containerPath": "/var/app/public" },
        { "hostPath": "${APP_DATA_DIR}/watched", "containerPath": "/var/app/tmp/imports/watched" },
        { "hostPath": "${APP_DATA_DIR}/storage", "containerPath": "/var/app/storage" }
      ],
      "healthCheck": {
        "test": "pgrep -f sidekiq",
        "interval": "10s",
        "retries": 30,
        "timeout": "10s"
      },
      "dependsOn": {
        "dawarich_db": { "condition": "service_healthy" },
        "dawarich_redis": { "condition": "service_healthy" },
        "dawarich_app": { "condition": "service_healthy" }
      }
    }
  ]
}
